---
title: 'Exercise 10: Tables'
author: 'Oliver Nemeth'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error=TRUE)
```

## Section 1: Practice making summary tables

Some of this section is review from the "grouping and summarizing" lesson. We will use the urban wildlife data again.

```{r}
library(tidyverse)
library(here)
install.packages("flextable")
install.packages("officer")
library(flextable)
library(officer)

urban_data <-read_csv("data/Murray-Sanchez_urban-wildlife.csv")


# Create a summary table of sample sizes by study, keeping the citation information
summ_studies <- urban_data %>%
  group_by(study, TITLE, AUTHORS, YEAR, JOURNAL) %>%
  summarize(n=n())
head(summ_studies)

# Create a summary table of sample sizes by study and health metric
summ_health <- urban_data %>%
  group_by(study, health) %>%
  summarize(n=n())
head(summ_health)
# Then make the metrics into columns
summ_health <- summ_health %>%
  pivot_wider(id_cols = study, names_from = health, 
              values_from = n, values_fill = 0)

# Then, add back in the citation information
citations <- distinct(urban_data, study, TITLE, AUTHORS, YEAR, JOURNAL)
summ_health <- left_join(summ_health, citations, by= "study")
head(summ_health)

```

## Section 2: Practice designing summary tables

```{r}
# Rename the columns of summ_health to be appropriate for display
summ_health <- summ_health %>%
  rename('Study'=study,
              "Toxicants" = toxicants,
              "Condition" = condition,
              "Stress" = stress,
              "Parasites" = parasites,
              "Title" = TITLE,
              "Authors" = AUTHORS,
              "Year" = YEAR,
              "Journal" = JOURNAL) 

names(summ_health)

# Make sure formatting of Journal column is consistent
head(summ_health$Journal)
summ_health <- summ_health %>%
  mutate(Journal = str_to_title(Journal))
head(summ_health$Journal)

# Alphabetize by authors
# Remove the study ID and title columns
# Reorder columns so citation information is first
summ_health <- summ_health %>%
  ungroup() %>%
  arrange(Authors) %>%
  select(Authors, Year, Journal, Toxicants, Condition, Stress, Parasites)
# Double check that the names are what you expect
names(summ_health)

# Remove the grouping column
# I think i did this in the last step? 
```


```{r}
# Use flextable to make this a "pretty" table

ft_health <- flextable(summ_health)
ft_health

# Use flextable to format the text
# Make the header row bold
ft_health <- ft_health %>%
  bold(part="header", bold = T)

# Create a new header for the sample sizes
summ_health <- summ_health %>%
  mutate(Sample_Size = Toxicants + Condition + Stress + Parasites) %>%
  rename("Sample Size" = Sample_Size)

ft_health <- flextable(summ_health)

head(summ_health)

ft_health

# Center this label
ft_health <- ft_health %>%
  align(part = "header", j=8 , align = "center")
ft_health

```


## Section 3: Open-ended practice

```{r}
# Summarize the urban data
# Create a table of mean and SD of effect size (r) by host class AND habitat (aqterr)
head(urban_data)

summary_urban <- urban_data %>%
  group_by(host.class, aqterr) %>%
  summarise(
    mean_r = mean(r, na.rm = TRUE),
    sd_r = sd(r, na.rm = TRUE),
    n = n()
  ) 


# Export table to CSV with the following properties:
# Round numeric variables to three decimal places
# Rename the table to have informative names
# Step 1: Round numeric values and rename columns
summary_urban <- summary_urban %>%
  mutate(
    mean_r = round(mean_r, 3),
    sd_r = round(sd_r, 3)
  ) %>%
  rename(
    `Host Class` = host.class,
    `Habitat Type` = aqterr,
    `Mean Effect Size` = mean_r,
    `SD of Effect Size` = sd_r,
    `Sample Size` = n
  )

write.csv(summary_urban, "effect_size_by_hostclass_habitat.csv")


# Create a flexable table (starting from your raw summary, not the CSV output) 
# with the following properties:
# Round numeric variables to three decimal places
# Rename the table to have informative names

ft_urban_sum <- flextable(summary_urban)

ft_urban_sum
# Use the host class as a grouping variable
# So that duplicate values are not repeated



# Customize the table in one more way
ft_urban_sum <- ft_urban_sum %>%
  bold(part="header", bold = T)%>%
  font(fontname = "Times New Roman", part = "all")%>%
  width(width = 1, unit = "in")

# Display your final table in the Markdown document
ft_urban_sum

```

Recreate the table provided.

```{r}

recreate <- urban_data %>%
  group_by(host.class, health) %>%
  summarise(
    r_positive = sum(r > 0, na.rm = TRUE),  
    r_negative = sum(r < 0, na.rm = TRUE),  
    mean_r = mean(r, na.rm = TRUE)          
  ) %>%
  mutate(mean_r = round(mean_r, 3)) %>%
  rename("Host Class" = host.class,
         "Health Metric" = health,
         "# positive (r > 0)" = r_positive,
         " # negative (r < 0)" = r_negative,
         "Mean r" = mean_r)



recreate_table <- flextable(recreate) %>%
  merge_v(j= "Host Class") %>%
  bold(part="header", bold = T)%>%
  font(fontname = "Times New Roman", part = "all")%>%
  width(width = 1, unit = "in")

recreate_table
```

## Exercise 10 Questions

1. If you wanted to add mean effect sizes as well as sample sizes to your `summ_health` table, how would you organize the table? (How many columns would it have and what would there names be?) Why would you choose this over other alternatives?

> In order to keep the table from becoming too wide I would probably change the 4th column to just be health metric, then effect size, then finally sample size to give context for the effect size/

head(summ_health)

2. Which of the tables (sample size and the effect size table) would you be more likely to use in a report, and why?

> I would be more likley to use the effect size table in a report. I think showing the comparison of positive and negatice effect sizes and the mean is more useful, and sample size can be calculated from the table as well. 

